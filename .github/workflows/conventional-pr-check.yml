name: 'Conventional PR'

on:
  pull_request_target:
    types:
      - opened
      - edited
      - synchronize

jobs:
  pr-check:
    runs-on: ubuntu-22.04
    steps:
      - id: lint-pr-title
        run: |
          regex="^(DH-[0-9]+): .*$"
          if [[ "${{ github.event.pull_request.title }}" =~ $regex ]]; then
              echo "jira_ticket=${BASH_REMATCH[1]}" >> $GITHUB_OUTPUT
          else
              exit 1
          fi

      - uses: marocchino/sticky-pull-request-comment@v2
        # When the previous steps fails, the workflow would stop. By adding this
        # condition you can continue the execution with the populated error message.
        if: always() && (steps.lint-pr-title.outputs.jira_ticket == null)
        with:
          header: pr-title-lint-error
          message: |
            Pull Request titles must follow have the format "DH-XXXXX: <title>" linking it to the JIRA ticket number.

            Invalid PR title: ${{ github.event.pull_request.title }}

      # Delete a previous comment when the issue has been resolved
      - if: ${{ steps.lint-pr-title.outputs.jira_ticket != null }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: pr-title-lint-error
          message: |
            JIRA ticket: ${{ steps.lint-pr-title.outputs.jira_ticket }}
